"use client";

import { cn } from "@/lib/utils";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { FastLink } from "../../../../../components/fast-link";
import { useState } from "react";
import { redirect, useSearchParams } from "next/navigation";
import { signIn } from "../_actions/sign-in";
import { toast } from "sonner";

export function LoginForm({ className, ...props }: React.ComponentPropsWithoutRef<"form">) {
	const [isLoading, setIsLoading] = useState(false);
	const [emailValue, setEmailValue] = useState("");
	const [passwordValue, setPasswordValue] = useState("");
	const searchParams = useSearchParams();

	async function handleSignIn(e) {
		e.preventDefault();
		setIsLoading(true);
		const afterLogin = searchParams?.get("after-login");
		const res = await signIn({ username: emailValue, password: passwordValue });
		if (res?.ok) {
			if (res?.ok) toast.success(res?.message);
			if (res?.firstLogin) redirect(`/medibook/account?first-login=true${afterLogin ? `&after-login=${afterLogin}` : ""}`);
			redirect(afterLogin || `/medibook`);
		} else {
			setPasswordValue("");
			toast.error(res?.message);
		}
		setIsLoading(false);
	}

	return (
		<form onSubmit={handleSignIn} className={cn("flex light flex-col gap-6", className)} {...props}>
			<div className="flex flex-col items-center gap-2 text-center">
				<h1 className="text-2xl font-bold">Login to your account</h1>
				<p className="text-balance text-sm text-muted-foreground">Enter your email below to login to your account</p>
			</div>
			<div className="grid gap-6">
				<div className="grid gap-2">
					<Label htmlFor="username">Username</Label>
					<Input
						value={emailValue}
						onChange={(e) => setEmailValue(e.target.value)}
						name="username"
						id="username"
						type="username"
						placeholder="Email, Username or UserID"
						required
					/>
				</div>
				<div className="grid gap-2">
					<div className="flex items-center">
						<Label htmlFor="password">Password</Label>
						<FastLink href="/login/help" className="ml-auto text-sm underline-offset-4 hover:underline">
							Forgot your password?
						</FastLink>
					</div>
					<Input value={passwordValue} onChange={(e) => setPasswordValue(e.target.value)} name="password" id="password" type="password" required />
				</div>
				<Button type="submit" className="w-full bg-white">
					Login
				</Button>
				<div className="relative text-center text-sm after:absolute after:inset-0 after:top-1/2 after:z-0 after:flex after:items-center after:border-t after:border-border">
					<span className="relative z-10 bg-background px-2 text-muted-foreground">Or continue with</span>
				</div>
				<Button disabled variant="outline" className="w-full">
					<svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 37.6 30.26">
						<path
							d="M14.04,14.8c.14-.03.15.06.16.16-.56.92-2.13,1.1-3.43,1.44-.31.08-.55.14-.83.19-.43.07-.82.1-1.31.14-.4.04-.81.11-1.53.07-1.07-.06-1.36-.06-2.08-.08-1.1-.04-2.67.25-3.67.96-.51.36-.55,1.07-1.36,1.2.12-.33.34-.57.32-1.04,1.42-1.74,3.36-2.61,6.7-2.55.61,0,1.24.18,1.84.24,1.51.15,2.05-.02,2.93-.08.19-.01.48-.07.55-.08.19-.03.41-.11.59-.16.7-.2.76-.21,1.12-.4Z"
							style={{ fill: "#fff", fillRule: "evenodd" }}
						/>
						<g>
							<path d="M31.04,8.89c-.51-.18-.86-.53-1.04-1.04.67-.29.83.59,1.04,1.04Z" style={{ fill: "#fff", fillRule: "evenodd" }} />
							<path
								d="M35.77,16.94c.59.98.92,1.77,1.18,2.64.06.89.75,1.17.64,2.23-1.95-.47-2.93-1.91-3.27-3.99-.1-.4.25-.34.24-.64-.52-.8-1.18-1.42-1.92-2.08-.23-.21-.38-.61-.8-.48-.23.4.27.71.48.96.24.29.43.62.72.8.27.66.5,1.36.88,1.91.21.93.52,1.88,1.12,2.47.29.28.81.45,1.04.88.16.29.12.69.24,1.04.2.59.62,1.14.72,1.83-.31.18-.58-.09-.88.08-.03,1.15.75,1.49.88,2.47-1.25.06-2-.46-3.19-.16-.61.15-1.45.48-2.16.8-.66.3-1.44.96-1.91.96-.49,0-.84-.52-1.36-.72-1.68-.63-3.75-.01-5.11.56-.74.31-1.49.96-2.47.88-.41-.69.46-1.23.56-1.91-2.77-.25-4.88.87-6.62,1.91-.43.47-1.1,1.05-1.99.8.06-.67.74-.9,1.12-1.28.09-.09.13-.28.24-.4.19-.21.3-.36.56-.64.28-.3.53-.72.8-1.2-.15-.14-.48-.23-.72-.08-.14.09-.19.04-.48.16-.54.23-1.08.66-1.6,1.04-.26.19-.55.36-.8.56-.45.36-.72.61-1.28.96-.47.29-1.1.94-1.76.8-.09-.53.14-1.07.32-1.59.32-.96.46-1.97.72-3.03.39-1.61,1.17-2.99,2.23-3.99,1.06-.45,2.55-.4,3.83-.32.05.45-.64.72-1.04,1.04-.19.15-.43.31-.64.48-.46.39-.84.74-1.28,1.2-.27.65-.72,1.16-1.12,1.68-.39.51-.92.91-1.2,1.52.55.22,1.08-.34,1.51-.64,1.43-.98,2.6-2.32,3.67-3.75.55-.33.98-.74,1.52-1.12,1.03-.72,2.44-.96,3.59-1.6.53-.29.97-.86,1.6-.8-.34,1.88-1.79,3.01-3.11,4.07-1.09.88-2.03,1.97-2.55,3.59.39.14.57-.36.72-.56,1.04-1.37,2.58-2.56,4.07-3.59-.35,1.4-1.68,1.83-1.51,3.75.49-.42.83-1.05,1.19-1.59.37-.55.66-1.15,1.12-1.6,0-.53.53-.98.64-1.6.09-.49-.07-1.05,0-1.52.11-.78.51-1.22.8-1.75.03-.64.12-1.46.16-2.31.02-.55.32-1.26-.24-1.44-.39.23-.28.73-.4,1.04-.09.22-.28.57-.4.8-.29.58-.59.87-1.04,1.36-.18.2-.37.49-.56.64-.22.17-.61.27-.88.48-.28.22-.56.51-1.04.72-.58.26-.92.2-1.67.4-2.01.52-5.31-.19-7.1,1.12-.3.22-.51.69-.88.8-1.04-.2-.38-1.76-.72-3.19-.17-.69-.69-.98-.24-1.52,1.41-.34,3.92.21,5.27-.4.49-.22.61-.14.96-.64.23-.32.56-.99.4-1.76-.09-.4-.61-1.04-.96-1.2-.64-.28-1.92-.44-2.95-.32-.43.05-1.28.24-1.76.64-.52.43-1.09,1.34-1.52,1.36-.62.02-1.23-1.15-1.44-1.75-.77-.68-1.83-1.43-.72-2.39.26-.23.9-.64,1.28-.88,1.85-1.18,4.67-1.75,5.59-3.75,1.26-.92,3.38-.99,4.31-2.23.31-.98-.34-1.61-.32-2.55.44-.33,1.25.16,1.6.16.83-.35.96-1.79,2.16-1.52-.03.41-.36.67-.08.96.67-.13.7-.9,1.51-.88.16.19.19.51.16.88.08.26.44.25.48.56,1.53.42,2.43-.41,3.43-.96.47,1.36,1.47,2.2,3.43,2.07.09.09.09.28.08.48.47.22.86.52,1.27.8,1.07.87,1.91,2.72,2.48,4.23.09.24.23.41.32.64.22.58.23.98.56,1.6.45.84,1.45,1.5.64,2.23.34,1.18,1.08,1.95,1.6,2.95-.5.07-.61-.25-.96-.32-.44-1.1-.92-2.16-2.23-2.39-.18.24.17.54.59.74M33.51,11.21c.16-.52-.26-.84-.48-1.28-.38-.78-.6-1.88-1.12-2.31-.14-.12-.35-.16-.48-.24-.5-.88-.96-1.8-1.75-2.39-.11-.16-.08-.45-.16-.64-.59-.21-1.5.06-2-.08-.33-.37-.71-.67-.96-1.12-.78-.47-2.06-.34-2.87,0-.51.4-.86.94-1.52,1.2-.68-.23.03-1.33-.4-1.52-.46.15-.81.41-1.52.32-.14-.39-.31-.75-.88-.72.07.82.19,1.51.4,2,.64.05.67-.5,1.28-.48.13.51.2,1.08.56,1.36.52.01.71.36,1.12.48.44-.17.85-.37,1.28-.56.07.11.47.06.72.16.99.39,1.31,1.16,1.6,2.16-.21.73-.19,1.92-.88,1.92-.72,0-.96-2.13-2.23-1.84-.42.74.46,1.33.88,1.84.46.56,1.01,1.14,1.12,1.84.09.55.15,1.98-.32,2.07.26-1.71-1.09-2.4-2.47-2.71.14.5.75.6,1.04.96.04.05.06.21.08.24.13.21.32.41.32.72,0,.26-.47.06-.4.4.33.51.74.96,1.04,1.51.05.53.15,1.03.48,1.28.33-.1.27-.54.4-.8.13-.27.29-.64.56-.72.33,1.04.35,2.35.08,3.43-.03.12-.19.2-.24.32-.29.77-.25,1.88-.96,2.15-.13-.18-.19-.44-.16-.8-.3-.2-.03-.98-.48-1.04-.22.38,0,.74,0,1.12-.02,2.2-.69,4.04-1.2,5.99.45-.19.58-.73.8-1.12.78-1.39,1.77-2.74,2.39-4.15.02-.78.56-1.3.64-1.99.05-.48.13-.76.16-1.04.06-.53-.12-.89-.16-1.2-.03-.23.05-.47,0-.72-.2-.91-1.01-1.7-1.12-2.79-.04-.38.03-.69,0-1.04-.03-.34-.49-.95.16-1.2.84.62.99,1.94,1.52,2.87,0,1,.59,2.69.48,4.07-.04.44-.45.89,0,1.2.35-.31.27-1.06.72-1.28.32,1.71-.83,3.43-1.44,4.95-.49.66-.93,1.33-1.36,1.92-.57.8-1.28,1.46-1.44,2.55.35,0,.69-.42.96-.72.3-.32.61-.69.8-1.04.48-.39.98-.77,1.2-1.44.95-.7,1.35-1.94,2.07-2.87-.05-.5.18-.73.4-.96-.03,2.28-.94,4.29-1.52,6.46.8-.34.91-1.37,1.6-1.84.85.67,1.06,2.4,2.39,2.31-.3-.9-.94-1.66-1.28-2.63-.53-1.56-.59-3.31-.64-5.42-.01-.1,0-.08-.08-.16-.8-.28-.7-1.48-1.12-2.23-.15-.26-.43-.4-.56-.64-.27-.48-.23-1.29-.16-1.91,1.14.98,1.7,2.9,1.99,4.47.29.22.16.57.32.88.3.6.88.95.88,1.68,0,.73.01.96.16,1.52.09.33.13.76.24,1.04.04.11.19.14.24.24.19.41.27.81.56,1.2.27.35.57.68.96.88.1-.44-.43-.87-.72-1.36-.1-.17-.06-.36-.16-.56-.11-.21-.26-.27-.32-.48-.04-.13.04-.39,0-.56-.09-.42-.38-.92.16-1.12.37.11.49.46.96.48-.07-.56.5-.46.96-.64-.08-.4-.56-.39-.96-.48-.65-.54-1.32-.65-1.75-1.36-.48-.78-.62-2.41-.8-3.35-.18-.97-.3-2.03-.48-2.95-.75-1.16-.96-2.87-2.71-3.03-.02.61.55.62.8.96.33.64.98,1.63.56,2.31-.38-.2-.74-.43-1.2-.56-.52-.7-.81-1.59-1.36-2.23-.22-.26-.62-.32-.64-.72,1-1.17,1.04-3.12.16-4.39-.41-.2-.87-.35-1.2-.64-.4,0-.73-.07-.8-.4.38-.57,1.45-.39,2.15-.24.47.33.59,1.01,1.12,1.28.21-.08.1-.49.4-.48,1.08.41,1.96,1.21,1.84,2.39-.6-.6-1.27-1.13-2.32-1.28-.1,1.08,1.42.35,1.43,1.44-.07.2-.44.09-.4.4-.01.33.39.25.32.64,1.05.65,1.77,1.7,2.47,2.79.18.27.38.62.48.88.26.67,0,1.47.64,1.91.05-1.49-.2-2.67-.64-3.67.26-.16.43-.76.32-1.04.56.59.7,1.59,1.44,1.99ZM13.33,6.98c-.21.14-.17.53-.24.8-.29.53-.89.76-.8,1.68.52.06.84-.48,1.36-.56.43-.07.88.13,1.28.08.73-.1.93-.59,1.44-.88.31-.18.69.05.72-.4-.53-.91-2.69-.6-3.75-.72ZM7.82,10.81h-.16c-.09.78-.82,1.28-.48,2.23.29.06.43.31.72.16.47-.46,1.2-2.26-.08-2.39Z"
								style={{ fill: "#fff", fillRule: "evenodd" }}
							/>
						</g>
					</svg>
					Login with The English School
				</Button>
			</div>
			<div className="text-center text-sm">
				Don&apos;t have an account?{" "}
				<FastLink prefetch={true} href="/signup" className="underline underline-offset-4">
					Sign up
				</FastLink>
			</div>
		</form>
	);
}
